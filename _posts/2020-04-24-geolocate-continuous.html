---
layout: post
title:  "Geolocation - Continuous"
scripts: 
  - url: "https://cdn.jsdelivr.net/npm/vue@2.6.0/dist/vue.min.js"
    type: "absolute"
  - url: "/assets/src/LocalStorage.js"
    type: "relative"
categories: [geolocation]
inlinestyle: >
  <style>
  .app .geolocation--button {
    font-size: 1.5rem;
  }
  .hidden {
    display: none;
  }
  </style>
inlinescript: > 
  <script>
  const app = new Vue({
    el: '#geolocationapp',
    data: {
      dateString: '',
      geoLocationOptions: {
        enableHighAccuracy: true,
        timeout: 30000,
        maximumAge: 1000
      },
      lat: Number.parseFloat(0).toFixed(7),
      long: Number.parseFloat(0).toFixed(7),
      msg: '',
      store: new LocalStorage(),
      storeAvailable: false,
      stored: [],
      str: {
        idle: '',
        progress: 'working...',
        nolocation: 'geolocation unavailable'
      },
      timestamp: 0,
      watchId: 0
    },
    mounted: function() {
      this.storeAvailable = LocalStorage.isAvailable();
      if(this.storeAvailable) {
        this.storeList();
      }
    },
    methods: {
      geolocateStart: function (onSuccess, onErr, opts) {
        let id = 0;
        if (navigator.geolocation) {
          id = navigator.geolocation.watchPosition(onSuccess, onErr, opts);
        } else {
          onErr({ message: this.str.nolocation });
        }
        return id;
      },
      geolocateStop: function (id) {
        if (navigator.geolocation) {
          navigator.geolocation.clearWatch(id);
        } else {
          onErr({ message: this.str.nolocation });
        }
      },
      fileWriteText: function (fileName, fileContents) {
        let fwEl, 
          txtBlob,
          w = window;
        if (w && w.Blob && w.URL && w.URL.createObjectURL && fileName && fileContents) {
          txtBlob = new Blob([fileContents], { type: 'text/plain' });
          if (navigator && navigator.msSaveOrOpenBlob) {
            navigator.msSaveOrOpenBlob(txtBlob, fileName);
          } else {
            fwEl = this.$refs.fileWrite;
            fwEl.download = fileName;
            fwEl.href = window.URL.createObjectURL(txtBlob);
            fwEl.click();
          }
        }
      },
      onLocateError: function (e) {
        this.msg = e.message;
      },
      onLocateSuccess: function (pos) {
        this.lat = pos.coords.latitude.toFixed(7);
        this.long = pos.coords.longitude.toFixed(7);
        this.timestamp = pos.timestamp;
        this.dateString = new Date(this.timestamp).toLocaleString();
        this.msg = this.str.idle;
      },
      onLocationStart: function () {
        // button press handler
        this.watchId = this.geolocateStart(
          this.onLocateSuccess,
          this.onLocateError,
          this.geoLocationOptions
        );
      },
      onLocationStop: function () {
        this.geolocateStop(this.watchId);
      },
      onStoreAdd: function() {
        if(this.storeAvailable) {
          this.store.add(this.timestamp, {
            date: this.dateString,
            latitude: this.lat,
            longitude: this.long
          });
          this.storeList();
        }
      },
      onStoreClear: function() {
        if (this.storeAvailable) {
          this.store.clear();
          this.storeList();
        }
      },
      onStoreDownload: function() {
        let contents = "";
        for(let entry of this.stored) {
          contents = [entry.key, entry.value.date, entry.value.latitude, entry.value.longitude].join(",") + "\n" + contents;
        }
        contents = "timestamp, date, latitude, longitude" + "\n" + contents;
        this.fileWriteText("save.txt", contents);
      },
      storeList: function() {
        this.$set(this, 'stored', []);
        for(let entry of this.store) {
          this.stored.push(entry);
        }
        this.stored.sort(function(a,b) { return b.key - a.key; });
      }
    }
  });
  </script>
---
{% raw %}
<div id="geolocationapp" class="app">
  <div class="hidden">
    <a ref="fileWrite"></a>
  </div>
  <p>
    <button class="geolocation--button" @click.prevent="onLocationStart()">Start</button>
    <button class="geolocation--button" @click.prevent="onLocationStop()">Stop</button>
  </p>
  <h2>Latitude, Longitude</h2>
  <h3>({{ lat }},{{ long }})</h3>
  <h4>{{ dateString }}</h4>
  <p>{{ msg ? msg : '&nbsp;' }}</p>
  <p>
  <button class="geolocation--button" @click.prevent="onStoreAdd()">Save</button>
  </p>
  <table>
    <thead>
      <th>timestamp</th><th>date</th><th>latitude</th><th>longitude</th>
    </thead>
    <tbody>
      <tr v-for="storedValue in stored">
        <td>{{ storedValue.key }}</td>
        <td>{{ storedValue.value.date }}</td>
        <td>{{ storedValue.value.latitude }}</td>
        <td>{{ storedValue.value.longitude }}</td>
      </tr>
    </tbody>
  </table>
  <p>
  <button class="geolocation--button" @click.prevent="onStoreDownload()">Download</button>
  </p>
  <p>&nbsp;</p>
  <p>
  <button class="geolocation--button" @click.prevent="onStoreClear()">Clear</button>
  </p>
</div>
{% endraw %}
