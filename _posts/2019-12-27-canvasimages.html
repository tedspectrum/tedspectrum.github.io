---
layout: post
title: "Canvas Images"
categories: [features]
scripts:
  - url: "https://cdn.jsdelivr.net/npm/vue@2.6.0/dist/vue.min.js"
    type: "absolute"
  - url: "https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
    type: "absolute"
  - url: "/assets/src/core.js"
    type: "relative"
  - url: "/assets/src/TileMapViewer.js"
    type: "relative"
inlinestyle: >
  <style>
    .hidden {
      display: none;
    }
    canvas {
      background: lightblue;
      border: 1px solid black;
    }
  </style>
inlinescript: >
  <script>
  const app = new Vue({
    el: '#app',
    data: function () {
      let d = {
        changed: false,
        core: {},
        controlButton: {
          'disabled': true,
          'activeMsg': '',
          'msgLoading': 'Loading...',
          'msgReady': 'Start'
        },
        keypresses: {
          'a': false,
          'd': false,
          'w': false,
          's': false
        },
        tileMapViewer: {},
        viewHeight: 240,
        viewWidth: 320,
        moveRate: 8,
        tileMapURL: '/assets/canvasimages/tilemap.json',
        tileMap: {}
      };
      return d;
    },
    mounted: function() {
      let myself = this;
      myself.core = new Core();
      window.addEventListener("keydown", this.onKeyDown.bind(this));
      window.addEventListener("keyup", this.onKeyUp.bind(this));
      myself.controlButton.activeMsg = myself.controlButton.msgLoading;
      axios.get(myself.tileMapURL).then(function (res) {
        myself.$set(myself, 'tileMap', res.data);
        myself.controlButton.activeMsg = myself.controlButton.msgReady;
        myself.controlButton.disabled = false;
      });
    },
    methods: {
      onEruda: function () {
        this.core.eruda();
      },
      onFullScreen: function () {
        this.core.toggleFullScreen(this.$el);
      },
      onKeyDown: function (e) {
        if(this.keypresses[e.key] === false) {
          this.keypresses[e.key] = true;
        }
      },
      onKeyUp: function (e) {
        if(this.keypresses[e.key] === true) {
          this.keypresses[e.key] = false;
        }
      },
      run: function () {
        this.tileMapViewer = new TileMapViewer(
          {
            map: this.tileMap,
            spriteSheet: this.$refs.tiles,
            tilesize: 32,
            outputEl: this.$refs.layer1
          }
        );
        this.changed = true;
        this.update(0);
      },
      update: function (timestamp) {
        let myself = this;
        if (this.keypresses.a) { this.move(-1,0); }
        if (this.keypresses.d) { this.move(1,0); }
        if (this.keypresses.w) { this.move(0,-1); }
        if (this.keypresses.s) { this.move(0,1); }
        if (this.changed === true) { 
          this.changed = false;
          this.tileMapViewer.update();
        }
        window.requestAnimationFrame(myself.update);
      },
      move: function (moveX,moveY) {
        this.tileMapViewer.changeXY(moveX * this.moveRate, moveY * this.moveRate);
        this.changed = true;
      }
    }
  });  
  </script>
---
<div id="app" class="app">
  {% raw %}
  <div class="hidden">
    <image ref="tiles" width="640" height="640" src="/assets/canvasimages/tiles.png"></image>
  </div>
  <div>
    <button class="app-button" 
    :disabled="controlButton.disabled"
    @click.prevent="run()">{{ controlButton.activeMsg }}</button>
    <button @click="onFullScreen">Full Screen</button>
    <button @click="onEruda">Dev Console</button>
  </div>
  <canvas ref="layer1"
    :width="viewWidth" :height="viewHeight"
  >
  </canvas>
  <div>
    <button class="app-button" @click.prevent="move(-1,0)">Left (a)</button>
    <button class="app-button" @click.prevent="move(1,0)">Right (d)</button>
    <button class="app-button" @click.prevent="move(0,-1)">Up (w)</button>
    <button class="app-button" @click.prevent="move(0,1)">Down (s)</button>
  </div>
  {% endraw %}
</div>