---
layout: post
title: "Canvas Images"
categories: [features]
scripts:
  - url: "https://cdn.jsdelivr.net/npm/vue@2.6.0/dist/vue.min.js"
    type: "absolute"
  - url: "https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"
    type: "absolute"
  - url: "/assets/src/core.js"
    type: "relative"
  - url: "/assets/src/KeyHandler.js"
    type: "relative"
  - url: "/assets/src/TileMapViewer.js"
    type: "relative"
inlinestyle: >
  <style>
    .hidden {
      display: none;
    }
    canvas {
      background: lightblue;
      border: 1px solid black;
    }
    .grid--div-controller {
      width: 320px;
      display: grid;
      grid-template-columns: 50% 50%;
      grid-template-rows: auto;
      grid-template-areas: "top top" "left right" "bottom bottom";
    }
    .grid--button-top {
      grid-area: top;
      justify-self: center;
    }
    .grid--button-left {
      grid-area: left;
      justify-self: center;
    }
    .grid--button-right {
      grid-area: right;
      justify-self: center;
    }
    .grid--button-bottom {
      grid-area: bottom;
      justify-self: center;
    }
    .grid--button-controller {
      padding: 1.5em;
      margin: 0.5em;
      width: 4em;
      border-radius: 4em;
      background: gray;
      border:black 1px solid;
    }
  </style>
inlinescript: >
  <script>
  const app = new Vue({
    el: '#app',
    data: function () {
      let d = {
        changed: false,
        core: {},
        controlButton: {
          'disabled': true,
          'activeMsg': '',
          'msgLoading': 'Loading...',
          'msgReady': 'Start'
        },
        kb: {},
        tileMapViewer: {},
        viewHeight: 240,
        viewWidth: 320,
        moveRate: 8,
        mousepresses: {
          up: false,
          down: false,
          left: false,
          right: false
        },
        tileMapURL: '/assets/canvasimages/tilemap.json',
        tileMap: {},
        touches: {
          up: false,
          down: false,
          left: false,
          right: false
        }
      };
      return d;
    },
    mounted: function() {
      let myself = this;
      this.core = new Core();
      this.kb = new KeyHandler(window, {
        'up': 'w',
        'down': 's',
        'left': 'a',
        'right': 'd'
      });
      this.controlButton.activeMsg = this.controlButton.msgLoading;
      axios.get(this.tileMapURL).then(function (res) {
        myself.$set(myself, 'tileMap', res.data);
        myself.controlButton.activeMsg = myself.controlButton.msgReady;
        myself.controlButton.disabled = false;
      });
    },
    methods: {
      onEruda: function () {
        this.core.eruda();
      },
      onFullScreen: function () {
        this.core.toggleFullScreen(this.$el);
      },
      onMouseDown: function(buttonId) {
        if(this.mousepresses[buttonId] === false) {
          this.mousepresses[buttonId] = true;
        }
      },
      onMouseUp: function(buttonId) {
        if(this.mousepresses[buttonId] === true) {
          this.mousepresses[buttonId] = false;
        }
      },
      onTouchStart: function(buttonId) {
        if(this.touches[buttonId] === false) {
          this.touches[buttonId] = true;
        }
      },
      onTouchEnd: function(buttonId) {
        if(this.touches[buttonId] === true) {
          this.touches[buttonId] = false;
        }
      },
      onTouchCancel: function(buttonId) {
        if(this.touches[buttonId] === true) {
          this.touches[buttonId] = false;
        }
      },
      run: function () {
        this.tileMapViewer = new TileMapViewer(
          {
            map: this.tileMap,
            spriteSheet: this.$refs.tiles,
            tilesize: 32,
            outputEl: this.$refs.layer1
          }
        );
        this.kb.start();
        this.changed = true;
        this.boundUpdate = this.update.bind(this);
        this.boundUpdate(0);
      },
      update: function (timestamp) {
        if (this.touches.left) { this.move(-1,0); }
        if (this.touches.right) { this.move(1,0); }
        if (this.touches.up) { this.move(0,-1); }
        if (this.touches.down) { this.move(0,1); }
        if (!this.changed) {
          if (this.mousepresses.left) { this.move(-1,0); }
          if (this.mousepresses.right) { this.move(1,0); }
          if (this.mousepresses.up) { this.move(0,-1); }
          if (this.mousepresses.down) { this.move(0,1); }
        }
        if (!this.changed) {
          if (this.kb.key.left) { this.move(-1,0); }
          if (this.kb.key.right) { this.move(1,0); }
          if (this.kb.key.up) { this.move(0,-1); }
          if (this.kb.key.down) { this.move(0,1); }
        }
        if (this.changed === true) { 
          this.changed = false;
          this.tileMapViewer.update();
        }
        window.requestAnimationFrame(this.boundUpdate);
      },
      move: function (moveX,moveY) {
        this.tileMapViewer.changeXY(moveX * this.moveRate, moveY * this.moveRate);
        this.changed = true;
      }
    }
  });  
  </script>
---
<div id="app" class="app">
  {% raw %}
  <div class="hidden">
    <image ref="tiles" width="640" height="640" src="/assets/canvasimages/tiles.png"></image>
  </div>
  <div>
    <button class="app-button" 
    :disabled="controlButton.disabled"
    @click.prevent="run()">{{ controlButton.activeMsg }}</button>
    <button @click="onFullScreen">Full Screen</button>
    <button @click="onEruda">Dev Console</button>
  </div>
  <canvas ref="layer1"
    :width="viewWidth" :height="viewHeight"
  >
  </canvas>
  <div class="grid--div-controller">
    <div class="grid--button-top grid--button-controller" 
      @mousedown="onMouseDown('up')"
      @mouseup="onMouseUp('up')"
      @touchstart.prevent="onTouchStart('up')"
      @touchend.prevent="onTouchEnd('up')"
      @touchcancel.prevent="onTouchCancel('up')"
    >Up (w)</div>
    <div class="grid--button-left grid--button-controller" 
      @mousedown="onMouseDown('left')"
      @mouseup="onMouseUp('left')"
      @touchstart.prevent="onTouchStart('left')"
      @touchend.prevent="onTouchEnd('left')"
      @touchcancel.prevent="onTouchCancel('left')"
    >Left (a)</div>
    <div class="grid--button-right grid--button-controller" 
      @mousedown="onMouseDown('right')"
      @mouseup="onMouseUp('right')"
      @touchstart.prevent="onTouchStart('right')"
      @touchend.prevent="onTouchEnd('right')"
      @touchcancel.prevent="onTouchCancel(right)"
    >Right (d)</div>
    <div class="grid--button-bottom grid--button-controller" 
      @mousedown="onMouseDown('down')"
      @mouseup="onMouseUp('down')"
      @touchstart.prevent="onTouchStart('down')"
      @touchend.prevent="onTouchEnd('down')"
      @touchcancel.prevent="onTouchCancel('down')"
    >Down (s)</div>
  </div>
  {% endraw %}
</div>