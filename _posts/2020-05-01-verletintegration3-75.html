---
layout: post
title: "Verlet Integration 3.75"
scripts:
categories: [features]
inlinestyle: >
  <style>
    .app {
      font-size: 1.5rem;
    }
    canvas {
      display: block;
      top: 0px;
      left: 0px;
      border: 1px solid black;
    }
  </style>
inlinescript: >
  <script>
    window.onload = function () {
      const 
        // world
        width = 3200,
        height = 2400,
        bounce = 0.9
        gravity = 0.9,
        friction = 0.995,
        constraintIterations = 3,
        // display
        canvas = document.getElementById("canvas"),
        context = canvas.getContext("2d"),
        scaleX = canvas.width / width,
        scaleY = canvas.height / height,
        // step control
        timeElapsed = 0,
        timeNow = 0,
        timeLast = 0,
        timeStep = 83.3;  // 83.3 is 12 frames per second
        // data
      var
        pointerX = 0,
        pointerY = 0,
        forms = [],
        images = [],
        points = [],
        sticks = [];
      points.push(
        { x: 100, y: 120, oldx: 110, oldy: 110 },
        { x: 340, y: 120, oldx: 400, oldy: 120 },
        { x: 340, y: 340, oldx: 440, oldy: 360 },
        { x: 100, y: 340, oldx: 120, oldy: 400 }
      );
      sticks.push(
        { p0: points[0], p1: points[1] },
        { p0: points[1], p1: points[2] },
        { p0: points[2], p1: points[3] },
        { p0: points[3], p1: points[0] },
        { p0: points[0], p1: points[2], hidden: true },
      );
      forms.push({
        path: [
          points[0],
          points[1],
          points[2],
          points[3]
        ],
        color: "lightskyblue"
      });
      images.push({
        path: [
          points[0],
          points[1],
          points[2],
          points[3]
        ],
        image: document.getElementById("crate")
      });
      for (var si = 0; si < sticks.length; si++) {
        // set initial length of each stick
        sticks[si].length = distance(sticks[si].p0, sticks[si].p1);
      }
      canvas.addEventListener('click', onClick);
      update(0);

      function distance(p0, p1) {
        var dx = p1.x - p0.x,
          dy = p1.y - p0.y;
        // Pythagoras h2 = a2 + b2
        return Math.sqrt(dx * dx + dy * dy);
      }
      function onClick(e) {
        pointerX = e.offsetX;
        pointerY = e.offsetY;
      }

      function update(timeNow) {
        /*
          timeLast = time of last step
          timeNow = current time, time of update
          (timeNow - timeLast) = more time passed since last step
          timeElapsed = accumulated time passed since last step
          if timeElapsed bigger than step, 
            do step, reset timeElapsed, set timeLast to timeNow
        */
        timeElapsed = timeElapsed + timeNow - timeLast;
        // controlling frame rate
        if (timeElapsed > timeStep) {
          // updating model
          pointerInput();
          updatePoints();
          for (var iter = 0; iter < constraintIterations; iter++) {
            constrainPoints();
            updateSticks();
          }
          // drawing
          renderPreProcess();
          context.clearRect(0, 0, canvas.width, canvas.height);
          // renderPoints();
          // renderSticks();
          // renderForms();
          renderImages();
          // updating frame rate control data
          timeLast = timeNow;
          timeElapsed = 0;
        }
        //console.log(points, sticks);
        window.requestAnimationFrame(update);
      }
      function pointerInput() {
        if (pointerX !== 0 && pointerY !== 0) {
          var dx, dy;
          dx = (pointerX / scaleX) - points[0].x;
          dy = (pointerY / scaleY) - points[0].y;
          for (var i = 0; i < points.length; i++) {
            points[i].x = points[i].x + dx;
            points[i].y = points[i].y + dy;
            points[i].oldx = points[i].x;
            points[i].oldy = points[i].y;
          }
          // randomised spin
          points[0].oldx = points[0].x + Math.round(Math.random() * 100) - 50;
          points[0].oldy = points[0].y + Math.round(Math.random() * 100) - 50;
          // reset input
          pointerX = 0;
          pointerY = 0;
        }
      }
      function updateSticks() {
        var s, dx, dy, distance, difference, percent, offsetX, offsetY;
        for (var i = 0; i < sticks.length; i++) {
          s = sticks[i];
          dx = s.p1.x - s.p0.x;
          dy = s.p1.y - s.p0.y;
          distance = Math.sqrt(dx * dx + dy * dy);
          difference = s.length - distance;
          (difference !== 0) ? percent = difference / distance / 2 : percent = 0;
          //console.log(difference, percent);
          offsetX = dx * percent;
          offsetY = dy * percent;
          s.p0.x = s.p0.x - offsetX;
          s.p0.y = s.p0.y - offsetY;
          s.p1.x = s.p1.x + offsetX;
          s.p1.y = s.p1.y + offsetY;
        }
      }
      function updatePoints() {
        var p, i, vx, vy;
        for (i = 0; i < points.length; i++) {
          p = points[i];
          vx = (p.x - p.oldx) * friction;
          vy = (p.y - p.oldy) * friction;
          p.oldx = p.x;
          p.oldy = p.y;
          p.x += vx;
          p.y += vy;
          p.y += gravity;
        }
      }
      function constrainPoints() {
        var p, i, vx, vy;
        for (i = 0; i < points.length; i++) {
          p = points[i];
          vx = (p.x - p.oldx) * friction;
          vy = (p.y - p.oldy) * friction;

          if (p.x > width) {
            p.x = width;
            p.oldx = p.x + vx * bounce;
          }
          else if (p.x < 0) {
            p.x = 0;
            p.oldx = p.x + vx * bounce;
          }
          if (p.y > height) {
            p.y = height;
            p.oldy = p.y + vy * bounce;
          }
          else if (p.y < 0) {
            p.y = 0;
            p.oldy = p.y + vy * bounce;
          }
        }
      }
      function renderPreProcess() {
        var item, i;
        for (i = 0; i < points.length; i++) {
          item = points[i];
          item.renderX = Math.round(item.x * scaleX),
          item.renderY = Math.round(item.y * scaleY)
        }
      }
      function renderPoints() {
        var p, i, doublePI = Math.PI * 2;
        // clear all
        context.clearRect(0, 0, width, height);
        // draw all
        for (i = 0; i < points.length; i++) {
          p = points[i];
          context.beginPath();
          context.arc(p.renderX, p.renderY, 5, 0, doublePI);
          context.fill();
        }
      }
      function renderSticks() {
        var s, i;
        context.beginPath();
        for (i = 0; i < sticks.length; i++) {
          s = sticks[i];
          if (!s.hidden) {
            context.moveTo(s.p0.renderX, s.p0.renderY);
            context.lineTo(s.p1.renderX, s.p1.renderY);
          }
        }
        context.stroke();
      }
      function renderForms() {
        var f, i, j;
        for (i = 0; i < forms.length; i++) {
          f = forms[i];
          context.beginPath();
          context.fillStyle = f.color;
          context.moveTo(f.path[0].renderX, f.path[0].renderY);
          for(j = 1; j < f.path.length; j++) {
            context.lineTo(f.path[j].renderX, f.path[j].renderY);
          }
          context.fill();
        }
      }
      function renderImages() {
        var img, i, w, h, dx, dy, angle;
        for (i = 0; i < images.length; i++) {
          img = images[i];
          w = distance(img.path[0], img.path[1]) * scaleX,
          h = distance(img.path[0], img.path[3]) * scaleY,
          dx = img.path[1].x - img.path[0].x,
          dy = img.path[1].y - img.path[0].y,
          angle = Math.atan2(dy, dx);
        }
        context.save();
        context.translate(img.path[0].renderX, img.path[0].renderY);
        context.rotate(angle);
        context.drawImage(img.image, 0, 0, img.image.width, img.image.height);
        context.restore();
      }
    };
  </script>
---
{% raw %}
<h1>Verlet Integration 3.75</h1>
<p>Following along with a video from Youtube by "Coding Math"</p>
<p>Click mouse to position square</p>
<div class="app">
  <img id="crate" src="/assets/images/crate.png" width="24" height="24" />
  <canvas id="canvas" width="320" height="240"></canvas>
</div>
{% endraw %}